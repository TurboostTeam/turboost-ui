{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "filter",
  "type": "registry:block",
  "title": "Filter",
  "description": "A filter component",
  "dependencies": [
    "lucide-react",
    "dayjs",
    "lodash",
    "@tanstack/react-form"
  ],
  "registryDependencies": [
    "badge",
    "dropdown-menu",
    "popover",
    "input-group",
    "spinner"
  ],
  "files": [
    {
      "path": "registry/components/filter/utils/format-filter-values.ts",
      "content": "export function formatFilterValues(\n  values: Record<string, any>,\n  formatValue?: (field: string, value: any) => any,\n): Record<string, any> {\n  const filter: Record<string, any> = {};\n\n  for (const [key, value] of Object.entries(values)) {\n    filter[key] = formatValue?.(key, value) ?? value;\n  }\n\n  return filter;\n}\n",
      "type": "registry:file",
      "target": "components/turboost-ui/filter/utils/format-filter-values.ts"
    },
    {
      "path": "registry/components/filter/filter.tsx",
      "content": "import dayjs from \"dayjs\";\nimport { forEach, isPlainObject, omitBy, transform } from \"lodash\";\nimport { ChevronDown, Plus, Search, X } from \"lucide-react\";\nimport { useCallback, useState } from \"react\";\nimport { useForm } from \"@tanstack/react-form\";\nimport type { ReactElement, ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupInput,\n} from \"@/components/ui/input-group\";\nimport { Spinner } from \"@/components/ui/spinner\";\n\nconst isEmpty = (value: unknown): boolean => {\n  return (\n    typeof value === \"undefined\" ||\n    value === \"\" ||\n    (value instanceof Array && value.length === 0)\n  );\n};\n\nconst omitEmpty = (obj: FilterValues): FilterValues => omitBy(obj, isEmpty);\n\nconst formatRenderValue = (obj: FilterValues): FilterValues => {\n  return transform<FilterValues, FilterValues>(\n    obj,\n    (result, value, key) => {\n      if (isPlainObject(value) || Array.isArray(value)) {\n        forEach(formatRenderValue(value), (flattenedValue, flattenedKey) => {\n          if (Array.isArray(value)) {\n            if (typeof result[key] === \"undefined\") {\n              result[key] = [];\n            }\n          } else {\n            if (typeof result[key] === \"undefined\") {\n              result[key] = {};\n            }\n          }\n\n          result[key][flattenedKey] =\n            flattenedValue instanceof Date\n              ? dayjs(flattenedValue).format(\"YYYY-MM-DD\")\n              : flattenedValue;\n        });\n      } else {\n        result[key] =\n          value instanceof Date ? dayjs(value).format(\"YYYY-MM-DD\") : value;\n      }\n    },\n    {},\n  );\n};\n\nconst flattenObject = (obj: FilterValues): FilterValues => {\n  return transform<FilterValues, FilterValues>(\n    obj,\n    (result, value, key) => {\n      if (isPlainObject(value)) {\n        const nested = flattenObject(value);\n        forEach(nested, (nestedValue, nestedKey) => {\n          result[`${key}.${nestedKey}`] = nestedValue;\n        });\n      } else {\n        result[key] = value;\n      }\n    },\n    {},\n  );\n};\n\nexport interface FilterItemProps {\n  label: string;\n  field: string;\n  icon?: ReactNode;\n  render: ({\n    field: { value, onChange },\n  }: {\n    field: {\n      value: any;\n      onChange: (value: any) => void;\n    };\n  }) => ReactElement;\n  renderValue?: (options: {\n    label: string;\n    field: string;\n    value: any;\n  }) => ReactNode;\n  pinned?: boolean;\n}\n\nexport interface FilterSearchConfig {\n  value?: string;\n  // 搜索框左侧扩展内容\n  leading?: ReactNode;\n  // 搜索框右侧扩展内容\n  trailing?: ReactNode;\n  suffix?: ReactNode;\n  prefix?: ReactNode;\n  placeholder?: string;\n  disabled?: boolean;\n  className?: string;\n  onChange?: (value: string) => void;\n}\n\nexport interface FilterI18n {\n  addFilter?: string;\n}\n\nexport type FilterValues = Record<string, any>;\n\nexport interface FilterRenderers {\n  addFilter?: () => ReactNode;\n  filterItem?: (props: {\n    label: string;\n    field: string;\n    icon?: ReactNode;\n    value: string | undefined;\n    remove: () => void;\n  }) => ReactNode;\n}\n\nexport interface FilterProps {\n  className?: string;\n  loading?: boolean;\n  filters: Array<FilterItemProps>;\n  search?: false | FilterSearchConfig;\n  values?: FilterValues;\n  renderers?: FilterRenderers;\n  i18n?: FilterI18n;\n  onChange?: (values: FilterValues) => void;\n}\n\nexport function Filter({\n  className,\n  loading = false,\n  filters,\n  search,\n  values,\n  i18n,\n  renderers,\n  onChange,\n}: FilterProps): ReactElement {\n  const form = useForm({\n    defaultValues: {\n      query:\n        search && \"value\" in search && typeof search.value === \"string\"\n          ? search.value\n          : \"\",\n      filter: values || {},\n    },\n  });\n\n  // 将筛选条件分组为固定和非固定两类\n  const [{ fixedFilters, unfixedFilters }, setFilterGroups] = useState({\n    fixedFilters: filters.filter((item) => item.pinned),\n    unfixedFilters: filters.filter((item) => item.pinned !== true),\n  });\n\n  const handleFiltersChange = useCallback(() => {\n    onChange?.(omitEmpty(flattenObject(form.state.values.filter)));\n  }, [onChange, form]);\n\n  // 设置筛选条件固定状态\n  const setFilterFieldPinnedStatus = useCallback(\n    (field: string, pinned: boolean) => {\n      setFilterGroups((prev) => {\n        return {\n          ...prev,\n          fixedFilters: pinned\n            ? [\n                ...prev.fixedFilters,\n                ...prev.unfixedFilters\n                  .filter((item) => item.field === field)\n                  .map((item) => ({ ...item, pinned })),\n              ]\n            : prev.fixedFilters.filter((item) => item.field !== field),\n          unfixedFilters: pinned\n            ? prev.unfixedFilters.filter((item) => item.field !== field)\n            : [\n                ...prev.unfixedFilters,\n                ...prev.fixedFilters\n                  .filter((item) => item.field === field)\n                  .map((item) => ({ ...item, pinned })),\n              ],\n        };\n      });\n    },\n    [],\n  );\n\n  return (\n    <div className={cn(\"space-y-3\", className)}>\n      {typeof search !== \"undefined\" && search !== false && (\n        <div className=\"flex items-center gap-2\">\n          {search?.leading}\n\n          <form.Field\n            name=\"query\"\n            children={({ state: { value }, handleChange, handleBlur }) => (\n              <InputGroup className={search?.className}>\n                <InputGroupInput\n                  value={value}\n                  onChange={(e) => {\n                    handleChange(e.target.value);\n                  }}\n                  onBlur={handleBlur}\n                  placeholder={search?.placeholder}\n                  disabled={search?.disabled}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault();\n\n                      search?.onChange?.(value);\n                    }\n                  }}\n                />\n                <InputGroupAddon>\n                  {search?.prefix ?? <Search />}\n                </InputGroupAddon>\n                <InputGroupAddon align=\"inline-end\">\n                  {loading ? <Spinner /> : search?.suffix}\n                </InputGroupAddon>\n              </InputGroup>\n            )}\n          />\n\n          {search?.trailing}\n        </div>\n      )}\n\n      {filters.length > 0 && (\n        <div className=\"flex flex-wrap gap-2\">\n          {fixedFilters.map(({ field, label, icon, render, renderValue }) => {\n            const originalFilter = filters.find((item) => item.field === field);\n            const fieldValue = form.getFieldValue(`filter.${field}`);\n\n            // 获取筛选条件的值\n            const getValue = (): string | undefined => {\n              if (isEmpty(fieldValue)) {\n                return undefined;\n              } else {\n                return String(\n                  typeof renderValue !== \"undefined\"\n                    ? renderValue({\n                        field,\n                        label,\n                        value: formatRenderValue({\n                          [field]: fieldValue,\n                        })[field],\n                      })\n                    : formatRenderValue({\n                        [field]: fieldValue,\n                      })[field],\n                );\n              }\n            };\n\n            // 移除筛选条件\n            const remove = () => {\n              form.setFieldValue(`filter.${field}`, undefined);\n              close();\n\n              // 如果该筛选条件是非原固定筛选条件，则将其移除\n              if (originalFilter?.pinned !== true) {\n                setFilterFieldPinnedStatus(field, false);\n              }\n\n              handleFiltersChange();\n            };\n\n            const value = getValue();\n\n            return (\n              <Popover\n                // Dialog -> Popover -> ScrollArea 时会有滚动问题，需要加 modal={true}\n                // issue:https://github.com/shadcn-ui/ui/issues/922\n                modal={true}\n                defaultOpen={originalFilter?.pinned !== true}\n                onOpenChange={(open) => {\n                  // 关闭筛选弹窗的时候如果该筛选条件没有值，则将其移除固定项\n                  if (\n                    !open &&\n                    typeof fieldValue === \"undefined\" &&\n                    originalFilter?.pinned !== true\n                  ) {\n                    setFilterFieldPinnedStatus(field, false);\n                  }\n                }}\n                key={field}\n              >\n                <PopoverTrigger asChild className=\"whitespace-normal\">\n                  {typeof renderers?.filterItem !== \"undefined\" ? (\n                    renderers?.filterItem({\n                      label,\n                      icon,\n                      field,\n                      value,\n                      remove,\n                    })\n                  ) : (\n                    <Badge\n                      variant=\"outline\"\n                      className=\"hover:bg-accent rounded-full px-2 py-1\"\n                    >\n                      <div className=\"flex items-center gap-1\">\n                        <span>\n                          {value ? `${label}: ${value}` : `${label}`}{\" \"}\n                        </span>\n\n                        {!value && <ChevronDown className=\"size-4\" />}\n\n                        {value && (\n                          <X\n                            className=\"size-4 shrink-0 cursor-pointer\"\n                            onClick={(event) => {\n                              event.stopPropagation();\n                              remove();\n                            }}\n                          />\n                        )}\n                      </div>\n                    </Badge>\n                  )}\n                </PopoverTrigger>\n\n                <PopoverContent className=\"w-fit\">\n                  <form.Field\n                    name={`filter.${field}`}\n                    children={({ state: { value }, handleChange: onChange }) =>\n                      render({\n                        field: {\n                          value,\n                          onChange: (value) => {\n                            onChange(value);\n                            handleFiltersChange();\n                          },\n                        },\n                      })\n                    }\n                  />\n                </PopoverContent>\n              </Popover>\n            );\n          })}\n\n          {unfixedFilters.length > 0 && (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                {typeof renderers?.addFilter !== \"undefined\" ? (\n                  renderers?.addFilter()\n                ) : (\n                  <Badge\n                    variant=\"outline\"\n                    className=\"hover:bg-accent rounded-full px-2 py-1\"\n                  >\n                    <span>{i18n?.addFilter ?? \"Add Filter\"}</span>\n                    <Plus className=\"size-4 shrink-0\" />\n                  </Badge>\n                )}\n              </DropdownMenuTrigger>\n\n              <DropdownMenuContent>\n                {unfixedFilters.map(({ field, label }) => {\n                  return (\n                    <DropdownMenuItem\n                      key={field}\n                      onClick={() => {\n                        setFilterFieldPinnedStatus(field, true);\n                      }}\n                    >\n                      <div className=\"w-full text-center text-xs font-semibold\">\n                        {label}\n                      </div>\n                    </DropdownMenuItem>\n                  );\n                })}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n",
      "type": "registry:component",
      "target": "components/turboost-ui/filter/filter.tsx"
    }
  ]
}