{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "complex-filter",
  "type": "registry:block",
  "title": "Complex Filter",
  "description": "A complex filter component with logical operators and nested conditions",
  "dependencies": [
    "lucide-react"
  ],
  "registryDependencies": [
    "button",
    "select",
    "dropdown-menu"
  ],
  "files": [
    {
      "path": "registry/components/complex-filter/complex-filter.tsx",
      "content": "import { ChevronDown, Plus, X } from \"lucide-react\";\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport type { FC, ReactNode } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { cn } from \"@/lib/utils\";\n\nexport enum ComplexFilterType {\n  STRING = \"string\",\n  NUMBER = \"number\",\n  BOOLEAN = \"boolean\",\n  DATE = \"date\",\n  DATETIME = \"datetime\",\n}\n\nexport enum ComplexFilterLogical {\n  AND = \"$and\",\n  OR = \"$or\",\n}\n\nexport type ComplexFilterEqualityOperator = \"$eq\" | \"$ne\";\n\nexport type ComplexFilterComparisonOperator = \"$gt\" | \"$gte\" | \"$lt\" | \"$lte\";\n\nexport type ComplexFilterMembershipOperator = \"$in\" | \"$nin\";\n\nexport type ComplexFilterFullTextOperator = \"$fulltext\";\n\nexport type ComplexFilterOperator =\n  | ComplexFilterEqualityOperator\n  | ComplexFilterComparisonOperator\n  | ComplexFilterMembershipOperator\n  | ComplexFilterFullTextOperator;\n\nexport type ComplexFilterCondition = Record<\n  string,\n  Partial<Record<ComplexFilterOperator, any>>\n>;\n\nexport type ComplexFilterGroupValue = {\n  [K in ComplexFilterLogical]?: Array<ComplexFilterValue>;\n};\n\nexport type ComplexFilterValue =\n  | ComplexFilterGroupValue\n  | ComplexFilterCondition;\n\nexport type ComplexFilterValueFormat = \"object\" | \"string\";\n\n/**\n * 根据 valueFormat 映射到对应的值类型\n */\nexport type ComplexFilterValueByFormat<T extends ComplexFilterValueFormat> =\n  T extends \"string\" ? string : ComplexFilterValue;\n\nconst filterOperators: Record<\n  ComplexFilterType,\n  Array<ComplexFilterOperator>\n> = {\n  [ComplexFilterType.STRING]: [\"$eq\", \"$ne\"],\n  [ComplexFilterType.NUMBER]: [\"$eq\", \"$ne\", \"$gt\", \"$gte\", \"$lt\", \"$lte\"],\n  [ComplexFilterType.BOOLEAN]: [\"$eq\", \"$ne\"],\n  [ComplexFilterType.DATE]: [\"$eq\", \"$ne\", \"$gt\", \"$gte\", \"$lt\", \"$lte\"],\n  [ComplexFilterType.DATETIME]: [\"$eq\", \"$ne\", \"$gt\", \"$gte\", \"$lt\", \"$lte\"],\n};\n\nexport interface ComplexFilterItem {\n  type: ComplexFilterType;\n  label: string;\n  field: string;\n  render: (options: {\n    filterType: ComplexFilterType;\n    value: any;\n    operator?: ComplexFilterOperator;\n    disabled: boolean;\n    onChange: (value: any) => void;\n  }) => ReactNode;\n  operators?: Array<ComplexFilterOperator>;\n}\n\nexport interface ComplexFilterI18n {\n  operators: Record<ComplexFilterOperator, string>;\n  logicals: Record<ComplexFilterLogical, string>;\n  addCondition: string;\n  addGroup: string;\n  selectField: string;\n  selectOperator: string;\n  selectValue: string;\n  clearAll: string;\n}\n\nexport const defaultComplexFilterI18n: ComplexFilterI18n = {\n  operators: {\n    $eq: \"Equal\",\n    $ne: \"Not equal\",\n    $gt: \"Greater than\",\n    $gte: \"Greater than or equal\",\n    $lt: \"Less than\",\n    $lte: \"Less than or equal\",\n    $in: \"Includes\",\n    $nin: \"Excludes\",\n    $fulltext: \"Contains\",\n  },\n  logicals: {\n    $and: \"AND\",\n    $or: \"OR\",\n  },\n  addCondition: \"Add condition\",\n  addGroup: \"Add group\",\n  selectField: \"Select field\",\n  selectOperator: \"Select operator\",\n  selectValue: \"Select value\",\n  clearAll: \"Clear all\",\n};\n\nfunction isFilterGroup(\n  value: ComplexFilterValue,\n): value is ComplexFilterGroupValue {\n  return (\n    value !== null &&\n    typeof value === \"object\" &&\n    (ComplexFilterLogical.AND in value || ComplexFilterLogical.OR in value)\n  );\n}\n\nfunction cleanFilterValue(\n  value: ComplexFilterValue,\n): ComplexFilterValue | undefined {\n  if (isFilterGroup(value)) {\n    const logical =\n      ComplexFilterLogical.AND in value\n        ? ComplexFilterLogical.AND\n        : ComplexFilterLogical.OR;\n    const items = value[logical];\n\n    if (!items) return undefined;\n\n    const cleanedItems = items\n      .map((item) => cleanFilterValue(item))\n      .filter((item): item is ComplexFilterValue => item !== undefined);\n\n    if (cleanedItems.length === 0) return undefined;\n\n    return { [logical]: cleanedItems };\n  } else {\n    // 检查条件是否有效（有字段、运算符和值）\n    const entries = Object.entries(value);\n    if (entries.length === 0) return undefined;\n\n    const [, operatorValuePair] = entries[0];\n    if (!operatorValuePair || Object.keys(operatorValuePair).length === 0) {\n      return undefined;\n    }\n\n    // 检查运算符是否有对应的值\n    const operatorEntries = Object.entries(operatorValuePair);\n    const hasValidValue = operatorEntries.some(([, val]) => {\n      // 值不能是 undefined 或 null（对于数字，0 和空字符串是有效的）\n      return val !== undefined && val !== null && val !== \"\";\n    });\n\n    if (!hasValidValue) {\n      return undefined;\n    }\n\n    return value;\n  }\n}\n\nexport interface ComplexFilterConditionRowProps {\n  i18n: ComplexFilterI18n;\n  filters: Array<ComplexFilterItem>;\n  value: ComplexFilterCondition;\n  onChange: (value: ComplexFilterCondition) => void;\n  onRemove: () => void;\n}\n\nexport const ComplexFilterConditionRow: FC<ComplexFilterConditionRowProps> = ({\n  i18n,\n  filters,\n  value,\n  onChange,\n  onRemove,\n}) => {\n  const [field, operatorValuePair] = useMemo<\n    [\n      string | undefined,\n      Partial<Record<ComplexFilterOperator, any>> | undefined,\n    ]\n  >(() => {\n    const entries = Object.entries(value);\n    if (entries.length === 0) return [undefined, undefined];\n    return [entries[0][0], entries[0][1]];\n  }, [value]);\n\n  const [operator, targetValue] = useMemo<\n    [ComplexFilterOperator | undefined, any]\n  >(() => {\n    if (!operatorValuePair) return [undefined, undefined];\n    const entries = Object.entries(operatorValuePair);\n    if (entries.length === 0) return [undefined, undefined];\n    return [entries[0][0] as ComplexFilterOperator, entries[0][1]];\n  }, [operatorValuePair]);\n\n  const selectedFilter = useMemo(\n    () => filters.find((filter) => filter.field === field),\n    [filters, field],\n  );\n\n  const operators = useMemo(() => {\n    return selectedFilter\n      ? (selectedFilter.operators ?? filterOperators[selectedFilter.type])\n      : [];\n  }, [selectedFilter]);\n\n  const handleFieldChange = (newField: string) => {\n    onChange({ [newField]: {} });\n  };\n\n  const handleOperatorChange = (newOperator: ComplexFilterOperator) => {\n    if (!field) return;\n    onChange({ [field]: { [newOperator]: targetValue ?? \"\" } });\n  };\n\n  const handleValueChange = (newValue: any) => {\n    if (!field || !operator) return;\n    onChange({ [field]: { [operator]: newValue } });\n  };\n\n  return (\n    <div className=\"flex items-center gap-2\">\n      <Select value={field} onValueChange={handleFieldChange}>\n        <SelectTrigger className=\"min-w-[150px]\">\n          <SelectValue placeholder={i18n.selectField} />\n        </SelectTrigger>\n\n        <SelectContent>\n          {filters.map((filter) => (\n            <SelectItem key={filter.field} value={filter.field}>\n              {filter.label}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n\n      <Select\n        value={operator}\n        onValueChange={handleOperatorChange}\n        disabled={!selectedFilter}\n      >\n        <SelectTrigger className=\"min-w-[150px]\">\n          <SelectValue placeholder={i18n.selectOperator} />\n        </SelectTrigger>\n\n        <SelectContent>\n          {operators.map((op) => (\n            <SelectItem key={op} value={op}>\n              {i18n.operators[op]}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n\n      {selectedFilter?.render({\n        filterType: selectedFilter?.type,\n        value: targetValue,\n        operator,\n        disabled: !operator,\n        onChange: handleValueChange,\n      })}\n\n      <Button variant=\"ghost\" size=\"icon\" onClick={onRemove}>\n        <X className=\"h-4 w-4\" />\n      </Button>\n    </div>\n  );\n};\n\nexport interface ComplexFilterGroupProps {\n  i18n: ComplexFilterI18n;\n  filters: Array<ComplexFilterItem>;\n  value: ComplexFilterGroupValue;\n  onChange: (value: ComplexFilterGroupValue) => void;\n  onRemove?: () => void;\n}\n\nexport const ComplexFilterGroup: FC<ComplexFilterGroupProps> = ({\n  i18n,\n  filters,\n  value,\n  onChange,\n  onRemove,\n}) => {\n  const [logical, items]: [ComplexFilterLogical, Array<ComplexFilterValue>] =\n    useMemo(() => {\n      if (\n        ComplexFilterLogical.AND in value &&\n        value[ComplexFilterLogical.AND]\n      ) {\n        return [ComplexFilterLogical.AND, value[ComplexFilterLogical.AND]];\n      }\n      if (ComplexFilterLogical.OR in value && value[ComplexFilterLogical.OR]) {\n        return [ComplexFilterLogical.OR, value[ComplexFilterLogical.OR]];\n      }\n      return [ComplexFilterLogical.AND, []];\n    }, [value]);\n\n  const handleLogicalChange = (newLogical: ComplexFilterLogical) => {\n    onChange({ [newLogical]: items });\n  };\n\n  const handleItemChange = (index: number, newItem: ComplexFilterValue) => {\n    const newItems = [...items];\n    newItems[index] = newItem;\n    onChange({ [logical]: newItems });\n  };\n\n  const handleItemRemove = (index: number) => {\n    const newItems = items.filter((_, i) => i !== index);\n    if (newItems.length === 0 && onRemove) {\n      onRemove();\n    } else {\n      onChange({ [logical]: newItems });\n    }\n  };\n\n  const handleAddCondition = () => {\n    onChange({ [logical]: [...items, {}] });\n  };\n\n  const handleAddGroup = () => {\n    onChange({\n      [logical]: [...items, { [ComplexFilterLogical.AND]: [{}] }],\n    });\n  };\n\n  return (\n    <div className=\"flex gap-2\">\n      <div className=\"bg-background flex-1 rounded-lg border p-4\">\n        {items.length > 0 && (\n          <div className=\"mb-4 flex gap-2\">\n            {/* 左侧大括号连接线 + 逻辑运算符按钮 */}\n            {items.length > 1 && (\n              <div className=\"flex w-12 flex-col py-4 pl-4\">\n                {/* 上半部分 - 顶部圆角 + 垂直线 */}\n                <div className=\"border-border w-full flex-1 rounded-tl-md border-t-2 border-l-2\" />\n\n                {/* 逻辑运算符按钮 - 居中放置 */}\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"-translate-x-1/2 text-xs\"\n                  onClick={() => {\n                    const newLogical =\n                      logical === ComplexFilterLogical.AND\n                        ? ComplexFilterLogical.OR\n                        : ComplexFilterLogical.AND;\n                    handleLogicalChange(newLogical);\n                  }}\n                >\n                  {i18n.logicals[logical]}\n                </Button>\n\n                {/* 下半部分 - 垂直线 + 底部圆角 */}\n                <div\n                  className=\"border-border w-full flex-1 rounded-bl-md border-b-2 border-l-2\"\n                  style={{ height: \"calc(50% - 18px)\" }}\n                />\n              </div>\n            )}\n\n            {/* 右侧条件列表 */}\n            <div className=\"flex-1 space-y-3\">\n              {items.map((item, index) => (\n                <div key={index}>\n                  {isFilterGroup(item) ? (\n                    <ComplexFilterGroup\n                      i18n={i18n}\n                      filters={filters}\n                      value={item}\n                      onChange={(newValue) => handleItemChange(index, newValue)}\n                      onRemove={() => handleItemRemove(index)}\n                    />\n                  ) : (\n                    <ComplexFilterConditionRow\n                      i18n={i18n}\n                      filters={filters}\n                      value={item}\n                      onChange={(newValue) => handleItemChange(index, newValue)}\n                      onRemove={() => handleItemRemove(index)}\n                    />\n                  )}\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        <div className={cn(\"flex gap-2\", items.length > 1 && \"ml-12\")}>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"sm\" className=\"h-8\">\n                <Plus className=\"mr-1 h-4 w-4\" />\n                {i18n.addCondition}\n                <ChevronDown className=\"ml-1 h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"start\">\n              <DropdownMenuItem onClick={handleAddCondition}>\n                {i18n.addCondition}\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={handleAddGroup}>\n                {i18n.addGroup}\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      {onRemove && (\n        <Button variant=\"ghost\" size=\"icon\" onClick={onRemove}>\n          <X className=\"h-4 w-4\" />\n        </Button>\n      )}\n    </div>\n  );\n};\n\nexport interface ComplexFilterProps<\n  TFormat extends ComplexFilterValueFormat = \"object\",\n> {\n  filters: Array<ComplexFilterItem>;\n  i18n?: ComplexFilterI18n;\n  showClearAll?: boolean;\n  value?: ComplexFilterValueByFormat<TFormat>;\n  onChange?: (value: ComplexFilterValueByFormat<TFormat>) => void;\n}\n\nexport const ComplexFilter = <\n  TFormat extends ComplexFilterValueFormat = \"object\",\n>({\n  i18n = defaultComplexFilterI18n,\n  filters,\n  showClearAll = false,\n  value,\n  onChange,\n}: ComplexFilterProps<TFormat>) => {\n  // 内部维护完整的 value（包括空条件），用于 UI 显示和编辑\n  const [internalDisplayValue, setInternalDisplayValue] =\n    useState<ComplexFilterValue>({\n      [ComplexFilterLogical.AND]: [],\n    });\n\n  // 使用 ref 跟踪上一次清理后的 value 的字符串表示，用于去重\n  const lastCleanedValueStrRef = useRef<string>(\"\");\n\n  // 受控模式：当外部 value 变化时，需要同步到内部 displayValue\n  // 注意：只在外部真正变化时同步，避免因内部触发 onChange 导致的循环\n  useEffect(() => {\n    if (value !== undefined) {\n      const currentCleanedStr = lastCleanedValueStrRef.current;\n\n      // 根据 valueFormat 处理输入值\n      let objectValue: ComplexFilterValue;\n      if (typeof value === \"object\") {\n        objectValue = value;\n      } else {\n        objectValue = { [ComplexFilterLogical.AND]: [] };\n      }\n\n      const externalValueStr = JSON.stringify(objectValue);\n\n      // 只有当外部值与上次输出的清理值不同时才同步\n      // 这避免了因为我们输出清理值导致的无意义同步\n      if (externalValueStr !== currentCleanedStr) {\n        setInternalDisplayValue(objectValue);\n      }\n    }\n  }, [value, i18n]);\n\n  const handleChange = (newValue: ComplexFilterValue) => {\n    // 内部保存完整的 value（包括空条件）\n    setInternalDisplayValue(newValue);\n\n    // 对外输出时清理空条件\n    if (onChange) {\n      const cleaned = cleanFilterValue(newValue);\n      const finalObjectValue = cleaned ?? { [ComplexFilterLogical.AND]: [] };\n      const finalValueStr = JSON.stringify(finalObjectValue);\n\n      // 只在清理后的值真正改变时才调用 onChange\n      if (finalValueStr !== lastCleanedValueStrRef.current) {\n        lastCleanedValueStrRef.current = finalValueStr;\n\n        onChange(finalObjectValue as ComplexFilterValueByFormat<TFormat>);\n      }\n    }\n  };\n\n  const handleClearAll = () => {\n    const emptyValue = { [ComplexFilterLogical.AND]: [] };\n    setInternalDisplayValue(emptyValue);\n    if (onChange) {\n      const emptyValueStr = JSON.stringify(emptyValue);\n      lastCleanedValueStrRef.current = emptyValueStr;\n\n      onChange(emptyValue as unknown as ComplexFilterValueByFormat<TFormat>);\n    }\n  };\n\n  if (isFilterGroup(internalDisplayValue)) {\n    return (\n      <div className=\"space-y-4\">\n        <ComplexFilterGroup\n          i18n={i18n}\n          filters={filters}\n          value={internalDisplayValue}\n          onChange={handleChange}\n        />\n\n        {showClearAll && (\n          <div className=\"flex justify-end\">\n            <Button variant=\"ghost\" size=\"sm\" onClick={handleClearAll}>\n              {i18n.clearAll}\n            </Button>\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  return null;\n};\n",
      "type": "registry:component",
      "target": "components/turboost-ui/complex-filter/complex-filter.tsx"
    }
  ]
}